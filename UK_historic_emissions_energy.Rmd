---
title: "UK emissions and energy data"
author: "Aman Malik"
date: "2024-02-06"
output:
  html_document:
    code_folding: hide
    toc: yes
    number_sections: yes
    toc_float: yes
    theme: united
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = F, warning = F, cache = T)
```

```{r}

library(tidyverse)
library(ggthemes)
library(ggsci)
library(readxl)
library(ggrepel)
library(ggpubr)
library(openxlsx)
```

```{r}
# data <- read_excel("~/CEEW/GHG Platform/Economy-wide/GHGPI-Economy-wide-Estimates-2005-to-2018.xlsx",sheet = "Economywide estimation") %>% 
  data <- read_excel("data/GHG_Gujrat-Final-Energy-2005-to-2020.xlsx", 
    sheet = "consolidated") %>% 
  # select(-27) %>% 
  pivot_longer(`2005`:`2020`,names_to = "Year") %>% 
  filter(Gas %in% "CO2e (t) GWP-AR6") %>%
  filter(State %in% "Gujarat")

data_ippu <- read_excel("data/IPPU Emissions-Revised_Final 04-02-24_20240402.xlsx", 
    sheet = "GHG Emissions Statewise", range = "A4:AP2193") %>% filter(State=="Gujarat",Gas=="CO2EqGWP - AR6") %>% 
select(-c(12:27)) %>% 
  pivot_longer(c(`2005`:`2019`),names_to = "Year",values_to = "value") %>% 
  select(-c(5:6)) %>% 
  mutate("Level 7"="")

data_waste_afolu <- read_excel("data/GHGPI-Economy-wide-Estimates-2005-to-2018.xlsx",     sheet = "Economywide estimation") %>% 
  filter(Gas %in% "CO2e (t) GWP-AR6") %>%
  filter(State %in% "Gujarat") %>% 
  filter(`Level 1` %in% c("Waste","Agriculture, Forestry and Other Land Use")) %>% 
  select(-c("Economic Activity","Product")) %>% 
  pivot_longer(c(`2005`:`2018`),names_to = "Year",values_to = "value")

data <- bind_rows(data,data_ippu,data_waste_afolu)
#write.xlsx(data, file = "consolidated_sheet.xlsx")
 


```
# Emissions

## Economy-wide Emissions
```{r}
level1 <- data %>%
     mutate(`Emission / Removal / Bunker`=gsub(x = `Emission / Removal / Bunker`,"Removals","Emissions")) %>% 
#  filter(!is.na(`Emission / Removal / Bunker`)) %>% 
  group_by(`Level 1`,Year) %>% 
   summarise(value=sum(value)) %>% 
  ungroup() %>% 
  group_by(Year) %>% 
  mutate(percent=round(value/sum(value)*100,0))


  
ggplot(level1) +
  aes(x = Year, y = value/10^6, fill = `Level 1`,label = paste0(percent, "%")) +
  geom_col() +
  geom_text(position = position_stack(vjust = 0.5), size = 3, color = "black") + # Adjust the position and size of the text
 ggthemes::theme_pander() +
  labs(x = "", y = "Emissions (MtCO2e)",)+
  scale_fill_brewer(type = "qual")+
  theme(legend.position = "top",
        axis.text.x = element_text(size = 9, angle = 45, vjust = 0.8, hjust = 0.8))+
  guides(fill = guide_legend(nrow = 2))  # Set the number of rows in the legend

```

## Energy emissions
```{r}
level3_energy <- data %>%
     mutate(`Emission / Removal / Bunker`=gsub(x = `Emission / Removal / Bunker`,"Removals","Emissions")) %>% 
  filter(`Level 1`=="Energy") %>% 
  #  filter(!is.na(`Emission / Removal / Bunker`)) %>% 
  group_by(`Level 3`,Year) %>% 
   summarise(value=sum(value)) %>% 
  ungroup() %>% 
  group_by(Year) %>% 
  mutate(percent=round(value/sum(value)*100,0))

level3_energy_tot <- level3_energy %>% 
  group_by(Year) %>% 
  summarise(total=sum(value))

total_values <- aggregate(value ~ Year, level3_energy, sum)
  
ggplot() +
  geom_col(level3_energy,mapping = aes(x = Year, y = value/10^6, fill = `Level 3`))+
 geom_text(data = total_values, aes(x = Year, y = value/10^6, label = paste0(round(value/10^6, 1))), vjust = -0.5, color = "black", size = 4)+
 geom_text(level3_energy,mapping=aes(x = Year, y = value/10^6, fill = `Level 3`, label = ifelse(percent > 2, paste0(percent, "%"), "")), position = position_stack(vjust = 0.5), size = 3, color = "black")+# Adjust the position and size of the text
 ggthemes::theme_pander() +
  labs(x = "", y = "Emissions (MtCO2e)",title = "Energy sector emissions")+
  scale_fill_brewer(type = "qual")+
  theme(legend.position = "top",
        axis.text.x = element_text(size = 9, angle = 45, vjust = 0.8, hjust = 0.8))+
  guides(fill = guide_legend(nrow = 3))  # Set the number of rows in the legend

ggsave("output_plots/energy_emissions.png",
  device = "png", dpi = "print",
  width = 9, height = 6
)


```

## Energy emissions: Transport
```{r}
level4_trans <- data %>%
     mutate(`Emission / Removal / Bunker`=gsub(x = `Emission / Removal / Bunker`,"Removals","Emissions")) %>% 
  filter(`Level 1`=="Energy" & `Level 3`=="Transport") %>% 
  #  filter(!is.na(`Emission / Removal / Bunker`)) %>% 
  group_by(`Level 4`,Year) %>% 
   summarise(value=sum(value)) %>% 
  ungroup() %>% 
  group_by(Year) %>% 
  mutate(percent=round(value/sum(value)*100,0))


#Transport sector emissions  
ggplot(level4_trans) +
  aes(x = Year, y = value/10^6, fill = `Level 4`,label = paste0(percent, "%")) +
  geom_col() +
 geom_text(aes(label = ifelse(percent > 2, paste0(percent, "%"), "")),
            position = position_stack(vjust = 0.5), size = 3, color = "black") +# Adjust the position and size of the text
 ggthemes::theme_pander() +
  labs(x = "", y = "Emissions (MtCO2e)",title = "Transport sector emissions")+
  scale_fill_brewer(type = "qual")+
  theme(legend.position = "top",
        axis.text.x = element_text(size = 9, angle = 45, vjust = 0.8, hjust = 0.8))+
  guides(fill = guide_legend(nrow = 2))  # Set the number of rows in the legend
```

## Energy emissions: Industry
```{r}
#Industry sector emissions
level4_industry <- data %>%
     mutate(`Emission / Removal / Bunker`=gsub(x = `Emission / Removal / Bunker`,"Removals","Emissions")) %>% 
  filter(`Level 1`=="Energy" & `Level 3`=="Industries",!`Level 4` %in% c("Manufacture of Solid Fuels","Non-Ferrous Metals","Textile and Leather","Wood and wood products")) %>% 
  #  filter(!is.na(`Emission / Removal / Bunker`)) %>% 
  group_by(`Level 4`,Year) %>% 
   summarise(value=sum(value)) %>% 
  ungroup() %>% 
  group_by(Year) %>% 
  mutate(percent=round(value/sum(value)*100,0))
  pivot_wider(id_cols = 1,names_from = 1,values_from = value) %>% 
  mutate(`Food processing+Machinery+Construction`)

#Industry sector emissions  
ggplot(level4_industry) +
  aes(x = Year, y = value/10^6, fill = `Level 4`,label = paste0(percent, "%")) +
  geom_col() +
 geom_text(aes(label = ifelse(percent > 2, paste0(percent, "%"), "")),
            position = position_stack(vjust = 0.5), size = 3, color = "black") +# Adjust the position and size of the text
 ggthemes::theme_pander() +
  labs(x = "", y = "Emissions (MtCO2e)",title = "Industry sector emissions")+
  scale_fill_ucscgb()+
  theme(legend.position = "top",
        axis.text.x = element_text(size = 9, angle = 45, vjust = 0.8, hjust = 0.8))+
  guides(fill = guide_legend(nrow = 5))  # Set the number of rows in the legend

ggsave("output_plots/ipppu4.png",
  device = "png", dpi = "print",
  width = 8, height = 6
)


```

## IPPU Emissions
### Level 2
```{r}
level2_ippu <- data %>%
     mutate(`Emission / Removal / Bunker`=gsub(x = `Emission / Removal / Bunker`,"Removals","Emissions")) %>% 
  filter(`Level 1`=="Industrial Processes and Product Use") %>% 
  #  filter(!is.na(`Emission / Removal / Bunker`)) %>% 
  group_by(`Level 2`,Year) %>% 
   summarise(value=sum(value)) %>% 
  ungroup() %>% 
  group_by(Year) %>% 
  mutate(percent=round(value/sum(value)*100,0))

totals <- aggregate(value ~ Year, data = level2_ippu, FUN = sum)
  
ggplot() +
  geom_col(level2_ippu,mapping=aes(x = Year, y = value/10^6, fill = `Level 2`,label = paste0(percent, "%"))) +

 # geom_text(aes(label = ifelse(percent > 2, paste0(percent, "%"), "")),
 #            position = position_stack(vjust = 0.5), size = 3, color = "black") +# Adjust the position and size of the text
  
  geom_text(data = totals, mapping=aes(x=Year,y=value/10^6,label = paste0(round(value/10^6,1))), 
            position = position_stack(vjust = 1.05), size = 3, color = "black")+
 ggthemes::theme_pander() +
  labs(x = "", y = "Emissions (MtCO2e)",title = "IPPU sector emissions")+
  scale_fill_brewer(type = "qual")+
  theme(legend.position = "top",
        axis.text.x = element_text(size = 9, angle = 45, vjust = 0.8, hjust = 0.8))+
  guides(fill = guide_legend(nrow = 3,title = NULL))  # Set the number of rows in the legend

ggsave("output_plots/ippu_energy.png",
  device = "png", dpi = "print",
  width = 8, height = 6
)

```

### Level 3
```{r}
level3_ippu <- data %>%
     mutate(`Emission / Removal / Bunker`=gsub(x = `Emission / Removal / Bunker`,"Removals","Emissions")) %>% 
  filter(`Level 1`=="Industrial Processes and Product Use") %>% 
  #  filter(!is.na(`Emission / Removal / Bunker`)) %>% 
  group_by(`Level 3`,Year) %>% 
   summarise(value=sum(value)) %>% 
  ungroup() %>% 
  group_by(Year) %>% 
  mutate(percent=round(value/sum(value)*100,0))


  
ggplot(level3_ippu %>% filter (Year>2007)) +
  aes(x = Year, y = value/10^6, fill = `Level 3`,label = paste0(percent, "%")) +
  geom_col() +
geom_text(aes(label = ifelse(percent > 4, paste0(percent, "%"), "")),
            position = position_stack(vjust = 0.5), size = 3, color = "black") +# Adjust the position and size of the text
 ggthemes::theme_pander() +
  labs(x = "", y = "Emissions (MtCO2e)",title = "IPPU sector emissions")+
  scale_fill_brewer(type = "qual")+
  theme(legend.position = "top",
        axis.text.x = element_text(size = 9, angle = 45, vjust = 0.8, hjust = 0.8))+
  guides(fill = guide_legend(nrow = 3))  # Set the number of rows in the legend


ggsave("output_plots/ippu_level3.png",
  device = "png", dpi = "print",
  width = 8, height = 6
)
```

## Waste emissions
### Level 2
```{r}
level2_waste <- data %>%
     mutate(`Emission / Removal / Bunker`=gsub(x = `Emission / Removal / Bunker`,"Removals","Emissions")) %>% 
  filter(`Level 1`=="Waste") %>% 
  #  filter(!is.na(`Emission / Removal / Bunker`)) %>% 
  group_by(`Level 2`,Year) %>% 
   summarise(value=sum(value)) %>% 
  ungroup() %>% 
  group_by(Year) %>% 
  mutate(percent=round(value/sum(value)*100,0))

ggplot(level2_waste) +
  aes(x = Year, y = value/10^6, fill = `Level 2`,label = paste0(percent, "%")) +
  geom_col() +
geom_text(aes(label = ifelse(percent > 2, paste0(percent, "%"), "")),
            position = position_stack(vjust = 0.5), size = 3, color = "black") +# Adjust the position and size of the text
 ggthemes::theme_pander() +
  labs(x = "", y = "Emissions (MtCO2e)",title = "IPPU sector emissions")+
  scale_fill_brewer(type = "qual")+
  theme(legend.position = "top",
        axis.text.x = element_text(size = 9, angle = 45, vjust = 0.8, hjust = 0.8))+
  guides(fill = guide_legend(nrow = 1,title = NULL))  # Set the number of rows in the legend

ggsave("output_plots/ind_wastewater.png",
  device = "png", dpi = "print",
  width = 8, height = 6
)

```


### Level 3
```{r}
level3_waste <- data %>%
     mutate(`Emission / Removal / Bunker`=gsub(x = `Emission / Removal / Bunker`,"Removals","Emissions")) %>% 
  filter(`Level 1`=="Waste",`Level 2` == "Industrial Wastewater") %>% 
  #  filter(!is.na(`Emission / Removal / Bunker`)) %>% 
  group_by(`Level 3`,Year) %>% 
   summarise(value=sum(value)) %>% 
  ungroup() %>% 
  group_by(Year) %>% 
  mutate(percent=round(value/sum(value)*100,0)) %>% 
  filter(`Level 3` %in% c("Pulp & Paper","Iron & Steel","Petroleum","Sugar") )

ggplot(level3_waste) +
  aes(x = Year, y = value/10^6, fill = `Level 3`,label = paste0(percent, "%")) +
  geom_col()+
geom_text(aes(label = ifelse(percent > 2, paste0(percent, "%"), "")),
            position = position_stack(vjust = 0.5), size = 3, color = "black") +# Adjust the position and size of the text
 ggthemes::theme_pander() +
  labs(x = "", y = "Emissions (MtCO2e)",title = "Industrial waste emissions")+
  scale_fill_ucscgb()+
  theme(legend.position = "top",
        axis.text.x = element_text(size = 9, angle = 45, vjust = 0.8, hjust = 0.8))+
  guides(fill = guide_legend(nrow = 3,title = NULL))  # Set the number of rows in the legend

ggsave("output_plots/ind_level3_wastewater.png",
  device = "png", dpi = "print",
  width = 8, height = 6
)

```


## AFOLU Emissions/Sequestration

### Level 2
```{r}
level2_afolu <- data %>%
     mutate(`Emission / Removal / Bunker`=gsub(x = `Emission / Removal / Bunker`,"Removals","Emissions")) %>% 
  filter(`Level 1`=="Agriculture, Forestry and Other Land Use") %>% 
  #  filter(!is.na(`Emission / Removal / Bunker`)) %>% 
  group_by(`Level 2`,Year) %>% 
   summarise(value=sum(value)) %>% 
  ungroup() %>% 
  group_by(Year) %>% 
  mutate(percent=round(value/sum(value)*100,0))

ggplot(level2_afolu) +
  aes(x = Year, y = value/10^6, fill = `Level 2`,label = paste0(percent, "%")) +
  geom_col() +
#geom_text(aes(label = ifelse(percent > 2, paste0(percent, "%"), "")),
#            position = position_stack(vjust = 0.5), size = 3, color = "black") +# Adjust the position and size of the text
 ggthemes::theme_pander() +
  labs(x = "", y = "Emissions (MtCO2e)",title = "IPPU sector emissions")+
  scale_fill_brewer(type = "qual")+
  theme(legend.position = "top",
        axis.text.x = element_text(size = 9, angle = 45, vjust = 0.8, hjust = 0.8))+
  guides(fill = guide_legend(nrow = 1))  # Set the number of rows in the legend
```

### Level 3
```{r}
level3_afolu <- data %>%
     mutate(`Emission / Removal / Bunker`=gsub(x = `Emission / Removal / Bunker`,"Removals","Emissions")) %>% 
  filter(`Level 1`=="Agriculture, Forestry and Other Land Use") %>% 
  #  filter(!is.na(`Emission / Removal / Bunker`)) %>% 
  group_by(`Level 3`,Year) %>% 
   summarise(value=sum(value)) %>% 
  ungroup() %>% 
  group_by(Year) %>% 
  mutate(percent=round(value/sum(value)*100,0))

ggplot(level3_afolu) +
  aes(x = Year, y = value/10^6, fill = `Level 3`,label = paste0(percent, "%")) +
  geom_col() +
#geom_text(aes(label = ifelse(percent > 2, paste0(percent, "%"), "")),
#            position = position_stack(vjust = 0.5), size = 3, color = "black") +# Adjust the position and size of the text
 ggthemes::theme_pander() +
  labs(x = "", y = "Emissions (MtCO2e)",title = "AFOLU sector emissions")+
  scale_fill_ucscgb()+
  theme(legend.position = "top",
        axis.text.x = element_text(size = 9, angle = 45, vjust = 0.8, hjust = 0.8))+
    guides(fill = guide_legend(nrow = 4))  # Set the number of rows in the legend

```



# Energy-use

```{r}
activity <- read_excel("~/CEEW/GHG Platform/Energy/GHGPI-Energy-Estimates-by-CSTEP-2005-to-2018.xlsx",sheet = "Activity data") %>% 
  pivot_longer(`2005`:`2018`,names_to = "Year") %>% 
  filter(State == "Uttarakhand")


```

## Energy-level
```{r}
level3_activity <- activity %>% 
    group_by(`Level 3`,Year) %>% 
   summarise(value=sum(value,na.rm = T)) %>% 
  ungroup() %>% 
  group_by(Year) %>% 
  mutate(percent=round(value/sum(value)*100,0))

ggplot(level3_activity) +
  aes(x = Year, y = value/10^3, fill = `Level 3`,label = paste0(percent, "%")) +
  geom_col() +
#geom_text(aes(label = ifelse(percent > 2, paste0(percent, "%"), "")),
#            position = position_stack(vjust = 0.5), size = 3, color = "black") +# Adjust the position and size of the text
 ggthemes::theme_pander() +
  labs(x = "", y = "Total fuel consumed (kt)",title = "Fuel consumed")+
  scale_fill_ucscgb()+
  theme(legend.position = "top",
        axis.text.x = element_text(size = 9, angle = 45, vjust = 0.8, hjust = 0.8))+
  guides(fill = guide_legend(nrow = 3))  # Set the number of rows in the legend
```

## Transport sector
```{r}
level5_activity_trans <- activity %>% 
    filter(`Level 3`=="Transport") %>% 
    group_by(`Level 5`,Year) %>% 
   summarise(value=sum(value,na.rm = T)) %>% 
  ungroup() %>% 
  group_by(Year) %>% 
  mutate(percent=round(value/sum(value)*100,0))

ggplot(level5_activity_trans) +
  aes(x = Year, y = value/10^3, fill = `Level 5`,label = paste0(percent, "%")) +
  geom_col() +
geom_text(aes(label = ifelse(percent > 2, paste0(percent, "%"), "")),
            position = position_stack(vjust = 0.5), size = 3, color = "black") +# Adjust the position and size of the text
 ggthemes::theme_pander() +
  labs(x = "", y = "Total fuel consumed (kt)",title = "Fuel consumed")+
  scale_fill_ucscgb()+
  theme(legend.position = "top",
        axis.text.x = element_text(size = 9, angle = 45, vjust = 0.8, hjust = 0.8))+
  guides(fill = guide_legend(nrow = 2))  # Set the number of rows in the legend
```

### Transport sector disaggregated   
```{r}
level4_5_activity_trans <- activity %>% 
    filter(`Level 3`=="Transport") %>% 
    group_by(`Level 4`,`Level 5`,Year) %>% 
   summarise(value=sum(value,na.rm = T)) %>% 
  ungroup() %>% 
  group_by(Year,`Level 4`) %>% 
  mutate(percent=round(value/sum(value)*100,0))

ggplot(level4_5_activity_trans %>% filter(`Level 4`!="Navigation")) +
  aes(x = Year, y = value/10^3, fill = `Level 5`,label = paste0(percent, "%")) +
  geom_col() +
geom_text(aes(label = ifelse(percent > 2, paste0(percent, "%"), "")),
            position = position_stack(vjust = 0.5), size = 3, color = "black") +# Adjust the position and size of the text
 ggthemes::theme_pander() +
  facet_wrap(~`Level 4`,scales = "free")+
  labs(x = "", y = "Total fuel consumed (kt)",title = "Transport sector: Fuel consumed")+
  scale_fill_ucscgb()+
  theme(legend.position = "top",
        axis.text.x = element_text(size = 9, angle = 45, vjust = 0.8, hjust = 0.8))+
  guides(fill = guide_legend(nrow = 2))  # Set the number of rows in the legend

```

## Residential sector
```{r}
level5_activity_res <- activity %>% 
    filter(`Level 3`=="Residential") %>% 
    group_by(`Level 5`,Year) %>% 
   summarise(value=sum(value,na.rm = T)) %>% 
  ungroup() %>% 
  group_by(Year) %>% 
  mutate(percent=round(value/sum(value)*100,0))

ggplot(level5_activity_res) +
  aes(x = Year, y = value/10^3, fill = `Level 5`,label = paste0(percent, "%")) +
  geom_col() +
geom_text(aes(label = ifelse(percent > 2, paste0(percent, "%"), "")),
            position = position_stack(vjust = 0.5), size = 3, color = "black") +# Adjust the position and size of the text
 ggthemes::theme_pander() +
  labs(x = "", y = "Total fuel consumed (kt)",title = "Fuel consumed: Residential")+
  scale_fill_ucscgb()+
  theme(legend.position = "top",
        axis.text.x = element_text(size = 9, angle = 45, vjust = 0.8, hjust = 0.8))+
  guides(fill = guide_legend(nrow = 2))  # Set the number of rows in the legend
```

## Commercial sector
```{r}
level5_activity_comm <- activity %>% 
    filter(`Level 3`=="Commercial") %>% 
    group_by(`Level 5`,Year) %>% 
   summarise(value=sum(value,na.rm = T)) %>% 
  ungroup() %>% 
  group_by(Year) %>% 
  mutate(percent=round(value/sum(value)*100,0))

ggplot(level5_activity_comm) +
  aes(x = Year, y = value/10^3, fill = `Level 5`,label = paste0(percent, "%")) +
  geom_col() +
geom_text(aes(label = ifelse(percent > 2, paste0(percent, "%"), "")),
            position = position_stack(vjust = 0.5), size = 3, color = "black") +# Adjust the position and size of the text
 ggthemes::theme_pander() +
  labs(x = "", y = "Total fuel consumed (kt)",title = "Fuel consumed: Commercial")+
  scale_fill_ucscgb()+
  theme(legend.position = "top",
        axis.text.x = element_text(size = 9, angle = 45, vjust = 0.8, hjust = 0.8))+
  guides(fill = guide_legend(nrow = 2,title = NULL))  # Set the number of rows in the legend
```

## Agricultural sector
```{r}
level5_activity_agri <- activity %>% 
    filter(`Level 3`=="Agriculture") %>% 
    group_by(`Level 5`,Year) %>% 
   summarise(value=sum(value,na.rm = T)) %>% 
  ungroup() %>% 
  group_by(Year) %>% 
  mutate(percent=round(value/sum(value)*100,0))

ggplot(level5_activity_agri) +
  aes(x = Year, y = value/10^3, fill = `Level 5`,label = paste0(percent, "%")) +
  geom_col() +
geom_text(aes(label = ifelse(percent > 2, paste0(percent, "%"), "")),
            position = position_stack(vjust = 0.5), size = 3, color = "black") +# Adjust the position and size of the text
 ggthemes::theme_pander() +
  labs(x = "", y = "Total fuel consumed (kt)",title = "Fuel consumed: Agriculture")+
  scale_fill_ucscgb()+
  theme(legend.position = "top",
        axis.text.x = element_text(size = 9, angle = 45, vjust = 0.8, hjust = 0.8))+
  guides(fill = guide_legend(nrow = 2,title = NULL))  # Set the number of rows in the legend
```

## Industries sector
```{r}

industries <- read.csv("~/CEEW/GHG Platform/INdustry/EM Public state yearly industry energy use emissions.csv") %>% 
  mutate(financial_year_start_date=substr(financial_year_start_date,1,4)) %>% 
  rename(year=financial_year_start_date)


level1_indus <- industries %>% 
 group_by(industry_sector,year) %>% 
   summarise(value=sum(energy_consumed,na.rm = T)) %>% 
  ungroup() %>% 
  group_by(year) %>% 
  mutate(percent=round(value/sum(value)*100,0))


ggplot(level1_indus) +
  aes(x = year, y = value, fill = industry_sector) +
  geom_col() +
geom_text(aes(label = ifelse(percent > 2, paste0(percent, "%"), "")),
            position = position_stack(vjust = 0.5), size = 3, color = "black") +# Adjust the position and size of the text
 ggthemes::theme_pander() +
  labs(x = "", y = "Energy consumed (EJ)",caption = "EM: Public state yearly industry energy use emissions")+
  scale_fill_ucscgb()+
  theme(legend.position = "top",
        axis.text.x = element_text(size = 9, angle = 45, vjust = 0.8, hjust = 0.8))+
  guides(fill = guide_legend(nrow = 5))  # Set the number of rows in the legend
```


# Power
```{r}
power <- read.csv(file = "EM yearly generation data.csv",) %>% 
  rename(Year="Time") %>% 
  mutate(Year=substr(Year,1,4)) %>% 
  pivot_longer(cols = 2:9,names_to = "Source") %>% 
  group_by(Year) %>% 
  mutate(percent=round(value/sum(value)*100,0))

power_total <- power %>%
  group_by(Year) %>%
  summarize(total_value = sum(value))

ggplot() +
  geom_col(power,mapping = aes(x = Year, y = value, fill = Source))+
geom_text(power,mapping=aes(x = Year, y = value, fill=Source, label = ifelse(percent > 2, paste0(percent, "%"), "")),
            position = position_stack(vjust = 0.5), size = 3, color = "black")+ # Adjust the position and size of the text
  geom_text(data = power_total, aes(x = Year, y = total_value, label = round(total_value,0)),
            vjust = -0.5, size = 4, color = "black")+  # Add total values on top of bars
 ggthemes::theme_pander() +
  labs(x = "", y = "Electricity Generation (MU)",caption = "Source: CEA")+
  scale_fill_ucscgb()+
  theme(legend.position = "top",
        axis.text.x = element_text(size = 9, angle = 45, vjust = 0.8, hjust = 0.8))+
guides(fill = guide_legend(nrow = 2))  # Set the number of rows in the legend

ggsave("output_plots/power_generation.png",
  device = "png", dpi = "print",
  width = 8, height = 6
)



```

# Macroeconomy

```{r}
agri1 <- read_excel("GROSS STATE VALUE ADDED BY ECONOMIC ACTIVITY - AGRICULTURE.XLSX",     sheet = "T_31(iii)", skip = 5,na = c("-","-*"))%>% mutate(`...1`=gsub("\\*","",`...1`))
agri2 <- read_excel("GROSS STATE VALUE ADDED BY ECONOMIC ACTIVITY - AGRICULTURE.XLSX",     sheet = "T_31(iv)", skip = 5,na = c("-","-*")) %>% slice(1:33) %>% mutate(`...1`=gsub("\\*","",`...1`))

agri <- left_join(agri1,agri2,by="...1") %>% rename("State"="...1") %>% pivot_longer(cols = 2:13,names_to = "Year") %>% 
  mutate(sector="Agriculture")
###########################
bank1 <- read_excel("GROSS STATE VALUE ADDED BY ECONOMIC ACTIVITY - BANKING AND INSURANCE.XLSX",     sheet = "T_48(iii)", skip = 5,na = c("-","-*"))
bank2 <- read_excel("GROSS STATE VALUE ADDED BY ECONOMIC ACTIVITY - BANKING AND INSURANCE.XLSX",     sheet = "T_48(iv)", skip = 5,na = c("-","-*")) %>% slice(1:33) %>% mutate(...1=gsub(x = ...1,"\\*",replacement=""))

bank <- left_join(bank1,bank2,by="...1") %>% rename("State"="...1") %>% pivot_longer(cols = 2:13,names_to = "Year")  %>%  mutate(sector="Banking")
###########################3
cons1 <- read_excel(path = "GROSS STATE VALUE ADDED BY ECONOMIC ACTIVITY - CONSTRUCTION.XLSX",     sheet = "T_40(iii)", skip = 5,na = c("-","-*"))
cons2 <- read_excel("GROSS STATE VALUE ADDED BY ECONOMIC ACTIVITY - CONSTRUCTION.XLSX",     sheet = "T_40(iv)", skip = 5,na = c("-","-*")) %>% slice(1:33) %>% mutate(...1=gsub(x = ...1,"\\*",replacement=""))

cons <- left_join(cons1,cons2,by="...1") %>% rename("State"="...1") %>% pivot_longer(cols = 2:13,names_to = "Year")  %>% mutate(sector="Construction")
#############################
ind1 <- read_excel(path = "GROSS STATE VALUE ADDED BY ECONOMIC ACTIVITY - INDUSTRY.XLSX",     sheet = "T_44(iii)", skip = 5,na = c("-","-*"))
ind2 <- read_excel("GROSS STATE VALUE ADDED BY ECONOMIC ACTIVITY - INDUSTRY.XLSX",     sheet = "T_44(iv)", skip = 5,na = c("-","-*")) %>% slice(1:33) %>% mutate(...1=gsub(x = ...1,"\\*",replacement=""))

ind <- left_join(ind1,ind2,by="...1") %>% rename("State"="...1") %>% pivot_longer(cols = 2:13,names_to = "Year")  %>% mutate(sector="Industry")
###################

manf1 <- read_excel(path = "GROSS STATE VALUE ADDED BY ECONOMIC ACTIVITY - MANUFACTURING.XLSX",     sheet = "T_36(iii)", skip = 5,na = c("-","-*"))%>% mutate(`...1`=gsub("\\*","",`...1`))

manf2 <- read_excel("GROSS STATE VALUE ADDED BY ECONOMIC ACTIVITY - MANUFACTURING.XLSX",     sheet = "T_36(iv)", skip = 5,na = c("-","-*")) %>% slice(1:33) %>% mutate(...1=gsub(x = ...1,"\\*",replacement=""))

manf <- left_join(manf1,manf2,by="...1") %>% rename("State"="...1")  %>% pivot_longer(cols = 2:13,names_to = "Year") %>% mutate(sector="Manufacturing")
####################

serv1 <- read_excel(path = "GROSS STATE VALUE ADDED BY ECONOMIC ACTIVITY - SERVICES.XLSX",     sheet = "T_52(iii)", skip = 5,na = c("-","-*"))
serv2 <- read_excel("GROSS STATE VALUE ADDED BY ECONOMIC ACTIVITY - SERVICES.XLSX",     sheet = "T_52(iv)", skip = 5,na = c("-","-*")) %>% slice(1:33) %>% mutate(...1=gsub(x = ...1,"\\*",replacement=""))

serv <- left_join(serv1,serv2,by="...1") %>% rename("State"="...1") %>% pivot_longer(cols = 2:13,names_to = "Year")  %>% mutate(sector="Services")
####################

GVA_economy <- bind_rows(agri,bank,cons,ind,manf,serv) %>%
  mutate(State=trimws(State,"right")) %>% 
   group_by(Year,State) %>% 
  mutate(percent=round(value/sum(value)*100,0)) %>% 
  filter(State=="Uttarakhand") %>% 
  ungroup() %>% 
  group_by(sector) %>%
  mutate(Change = (value - lag(value))/lag(value)*100) %>%
  ungroup()
  

tot <- GVA_economy %>% group_by(State,Year) %>% summarise(value=sum(value))

ggplot(GVA_economy) +
  
  geom_col(aes(x = Year, y = value/100000, fill = sector)) +
geom_text(aes(x = Year, y = value/100000,fill=sector,label = ifelse(percent > 2, paste0(percent, "%"), "")),
            position = position_stack(vjust = 0.5), size = 3, color = "black")+ 
geom_text(data = tot,mapping = aes(x=Year, y=value/100000,label=round(value/100000,0),  vjust=-0.5))+
ggthemes::theme_pander() +
  labs(x = "", y = "GVA constant prices (000 crore rupees)",title ="GVA by sector",caption = "RBI handbook of Indian States")+
  scale_fill_uchicago()+
  theme(legend.position = "top",
        axis.text.x = element_text(size = 9, angle = 45, vjust = 0.8, hjust = 0.8))+
guides(fill = guide_legend(nrow = 2))  # Set the number of rows in the legend


# Change in GVA- by sector

ggplot()+
  geom_line(GVA_economy,mapping =aes(x=Year,y=value/100000, color=sector, group=sector))+
  geom_point(GVA_economy,mapping = aes(x=Year, y=value/100000, color=sector, group=sector), size=2)+
  geom_text_repel(GVA_economy%>% filter(Year!="2011-12"),mapping = aes(x=Year,y = value/100000,label=paste0(round(Change,1),"%"),group=sector,color=sector),vjust=-0.5,max.overlaps = Inf,size=3)+
  scale_y_continuous(sec.axis = sec_axis(~ ., name = "GVA by sector (000 crores)")) +
  scale_color_uchicago()+
   ggthemes::theme_pander() +
  labs(x = "", y = "GVA by sector (000 crores)",caption = "RBI: handbook of states in India")+
  theme(legend.position = "top",
        axis.text.x = element_text(size = 9, angle = 45, vjust = 0.8, hjust = 0.8))+
guides(fill = guide_legend(nrow = 2))  # Set the number of rows in the legend

```

# Forests
```{r}
forests1 <- read_excel("RBI_state_forest_cover.XLSX", 
    sheet = "T_101(i)", skip = 3,na = c("-","-*"))
forests2 <- read_excel("RBI_state_forest_cover.XLSX", 
    sheet = "T_101(ii)", skip = 3,na = c("-","-*")) %>% slice(1:37)

forests <- left_join(forests1,forests2,by="State/Union Territory") %>% 
  rename(State="State/Union Territory") %>% 
  select(1,9:19) %>% 
   pivot_longer(cols = 2:12,names_to = "Year") %>% 
  arrange(State, Year) %>%
  group_by(State) %>%
  mutate(Change = (value - lag(value))/lag(value)*100) %>%
  ungroup() %>% 
  filter(State %in% c("Uttarakhand","Himachal Pradesh"))

ggplot()+
  geom_line(forests,mapping =aes(x=Year,y=value/1000,color=State,group=State))+
  geom_point(forests,mapping =aes(x=Year,y=value/1000,color=State,group=State),size=2)+
  geom_text(forests %>% filter(Year!=2001),mapping = aes(x=Year,y = value/1000,label=paste0(round(Change,1),"%"),group=State),vjust=-0.5)+
  scale_color_wsj()+
   ggthemes::theme_pander() +
  labs(x = "", y = "Forest cover (000 sq km)",caption = "Source: India State of Forest Report 2001-2021, Forest Survey of India")+
  theme(legend.position = "top",
        axis.text.x = element_text(size = 9, angle = 45, vjust = 0.8, hjust = 0.8))+
guides(fill = guide_legend(nrow = 2))  # Set the number of rows in the legend

```

### Trees
```{r}
trees <- read_excel("RBI_state_tree_cover.XLSX", 
    sheet = "T_102", na = c("-","*"), skip = 3) %>% 
   rename(State="State/Union Territory") %>% 
  slice(1:37) %>% 
   pivot_longer(cols = 2:11,names_to = "Year") %>% 
  arrange(State, Year) %>%
  group_by(State) %>%
  mutate(Change = (value - lag(value))/lag(value)*100) %>%
  ungroup() %>% 
  filter(State %in% c("Uttarakhand","Himachal Pradesh"))

ggplot()+
  geom_line(trees,mapping =aes(x=Year,y=value,color=State,group=State))+
  geom_point(trees,mapping =aes(x=Year,y=value,color=State,group=State),size=2)+
  geom_text_repel(trees %>% filter(Year!=2001),mapping = aes(x=Year,y = value,label=paste0(round(Change,1),"%"),group=State,color=State),vjust=-0.5)+
  scale_color_wsj()+
   ggthemes::theme_pander() +
  labs(x = "", y = "Tree cover (sq km)",caption = "Source: India State of Forest Report 2001-2021, Forest Survey of India")+
  theme(legend.position = "top",
        axis.text.x = element_text(size = 9, angle = 45, vjust = 0.8, hjust = 0.8))+
guides(fill = guide_legend(nrow = 2))  # Set the number of rows in the legend
```



