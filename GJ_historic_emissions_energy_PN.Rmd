---
title: "GJ emissions and energy data"
author: "Aman Malik"
date: "2024-02-06"
output:
  html_document:
    code_folding: hide
    toc: yes
    number_sections: yes
    toc_float: yes
    theme: united
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = F, warning = F, cache = T)
```

```{r}

library(tidyverse)
library(ggthemes)
library(ggsci)
library(readxl)
library(ggrepel)
library(ggpubr)
library(openxlsx)
library(extrafont)
#font_import() # need to do this only once, so uncomment and run once
loadfonts(device = "win")
```


```{r}
# Color Palette CEEW and font type
my_custom_palette <- c("#575756", "#9d9d9c","#D5d7dc", "#C3E5F5", "#71c9eb", "#009cd8", "#8db824","#b4d48c", "#7da7d9","#A78D6D", "#5CB8E0")

theme_set(theme_pubclean(base_size = 16, base_family = "Calibri"))
```


```{r}
##data <- read_excel("C:/Users/Paras/Desktop/Uttarakhand graphs/GHGPI-Economy-wide-Estimates-2005-to-2018.xlsx",sheet = "Economywide estimation") %>% 
 data <- read_excel("C:/Users/Paras/Desktop/Uttarakhand graphs/GHGPI-Economy-wide-Estimates-2005-to-2018.xlsx", sheet = "consolidated") %>% 
 # select(-27) %>% 
  pivot_longer(`2005`:`2020`,names_to = "Year") %>% 
  filter(Gas %in% "CO2e (t) GWP-AR6") %>%  
  filter(State %in% "Uttarakhand")

data_ippu <- read_excel("C:/Users/Paras/Desktop/Uttarakhand graphs/IPPU Emissions-Revised_Final 04-02-24_20240402.xlsx", 
    sheet = "GHG Emissions Statewise", range = "A4:AP2193") %>% filter(State=="Uttarakhand",Gas=="CO2EqGWP - AR6") %>% 
select(-c(12:27)) %>% 
  pivot_longer(c(`2005`:`2019`),names_to = "Year",values_to = "value") %>% 
  select(-c(5:6)) %>% 
  mutate("Level 7"="")

data_waste_afolu <- read_excel("C:/Users/Paras/Desktop/Uttarakhand graphs/GHGPI-Economy-wide-Estimates-2005-to-2018.xlsx",     sheet = "Economywide estimation") %>% 
  filter(Gas %in% "CO2e (t) GWP-AR6") %>%
  filter(State %in% "Uttarakhand") %>% 
  filter(`Level 1` %in% c("Waste","Agriculture, Forestry and Other Land Use")) %>% 
  select(-c("Economic Activity","Product")) %>% 
  pivot_longer(c(`2005`:`2018`),names_to = "Year",values_to = "value")

data <- bind_rows(data,data_ippu,data_waste_afolu)
write.xlsx(data, file = "consolidated_sheet.xlsx")


```

# Emissions

## Economy-wide Emissions
```{r}
level1 <- data %>%
  group_by(`Level 1`,Year) %>% 
  filter(Emissions_Removal_Bunker=="Emissions") %>% 
   summarise(value=sum(value)) %>% 
  group_by(Year) %>% 
  mutate(percent=value/sum(value))

level1_tot <- level1 %>% 
  group_by(Year) %>% 
  summarise(tot=sum(value))
  # ungroup() %>% 
  # group_by(`Level 1`) %>%
  # mutate(Change = (value - lag(value))/lag(value)*100)

ggplot() +
    geom_col(level1, mapping=aes(x = Year, y = value/10^6, fill = `Level 1`,label = paste0(percent, "%")))+
 geom_text(data = level1_tot, aes(x = Year, y = tot/10^6, label = paste0(round(tot/10^6, 0))), vjust = -0.5, color = "black", size = 3) +
 #ggthemes::theme_pander() +
  labs(x = "", y = "Emissions (MtCO2e)",caption  = "IPPU emissions from 2020 unavailable. Waste and AFOLU emissions unavailable for 2019 and 2020")+
  scale_fill_manual(values = my_custom_palette)+
  theme(legend.position = "top",
        axis.text.x = element_text(size = 8, angle = 45, vjust = 0.8, hjust = 0.8))+
  guides(fill = guide_legend(nrow = 2))  # Set the number of rows in the legend

```

## Fuel-level emissions
```{r}
fuel_wise <- data %>% 
  filter(`Level 1`=="Energy") %>% 
  mutate(fuels=if_else(`Level 6` %in% c("Diesel-Retails","Furnace Oil","HSDO","LDO","Diesel","ATF","Motor Spirit","HSDO - Retail","Kerosene","Naptha","Petroleum Fuel"),"Liquid Petroleum Fuels",if_else(`Level 6` %in% c("Natural gas","LPG","Auto LPG","Gas","Natural Gas and its derivatives"),"Gaseous Petroleum Fuels",if_else(`Level 6` %in% c("Lignite","Coal","Coke","Coal and Lignite","Steam"),"Coal","Other Fuels")))) %>% 
  group_by(Year,fuels) %>% 
  summarise(value=sum(value)) %>% 
  mutate(percent=round(value/sum(value)*100,0))

#Type 1
d <- ggplot() +
  geom_col(fuel_wise,mapping = aes(x = Year, y = value/10^6, fill = fuels))+
   geom_text(fuel_wise,mapping=aes(x = Year, y = value/10^6, fill = fuels, label = ifelse(percent > 2, paste0(percent, "%"), "")), position = position_stack(vjust = 0.5), size =2.5, color = "white")+# Adjust the position and size of the text
 #  ggthemes::theme_pander() +
  labs(x = "", y = "Emissions (MtCO2e)",title = "Energy sector emissions")+
  theme_pubclean(base_size = 14)+
    scale_fill_manual(values = my_custom_palette)+
  theme(legend.position = "top",
        axis.text.x = element_text(size = 10, angle = 45, vjust = 0.8, hjust = 0.8))+
  guides(fill = guide_legend(nrow = 2))+  # Set the number of rows in the legend
  scale_x_discrete(breaks = seq(2005, 2020, by = 3))
  
ggsave("output_plots/emissions_by_fuel.png",
  device = "png", dpi = "print",
  width = 7, height = 6
)

# Type 2

fuel_wise <- data %>% 
  mutate(fuels=if_else(`Level 6` %in% c("Diesel-Retails","Furnace Oil","HSDO","LDO","Diesel","ATF","Motor Spirit","HSDO - Retail","Kerosene","Naptha","Petroleum Fuel"),"Liquid Petroleum Fuels",if_else(`Level 6` %in% c("Natural gas","LPG","Auto LPG","Gas","Natural Gas and its derivatives"),"Gaseous Petroleum Fuels",if_else(`Level 6` %in% c("Lignite","Coal","Coke","Coal and Lignite","Steam"),"Coal","Other Fuels")))) 

data2 <- fuel_wise %>% 
   filter(`Level 3` %in% c("Public Electricity Generation","Residential","Transport","Captive Power Plants","Industries")) %>% 
    #      c("Agriculture","Commercial","Fisheries")) %>% # Filtering these out as their emissions are small relative to total emissions
    select(`Level 3`,Year,value,fuels,`Level 6`) %>% 
  group_by(fuels,`Level 3`,Year) %>% 
  summarise(value=sum(value)) %>% 
  ungroup() %>% 
  pivot_wider(names_from = `Level 3`, values_from = value) %>% 
  mutate(`Electricity Generation`= `Captive Power Plants` + `Public Electricity Generation`) %>% 
  select(-3,-5) %>% 
  pivot_longer(3:6,values_to = "value",names_to = "sector") %>% 
  filter(!is.na(value))

f <- ggplot() +
  geom_col(data2 %>% filter(sector %in% c("Electricity Generation","Industries")), mapping = aes(x = Year, y = value/10^6, fill = fuels))+
  facet_wrap(~sector,scales = "free")+
  #ggthemes::theme_pander() +
  labs(x = "", y = "Emissions (MtCO2e)",title = "Emissions by fuel and enduse sector")+
    scale_fill_manual(values = my_custom_palette)+

  theme(legend.position = "top",
        axis.text.x = element_text(size = 10, angle = 45, vjust = 0.8, hjust = 0.8))+
  guides(fill = guide_legend(nrow = 2))+  # Set the number of rows in the legend
 scale_x_discrete(breaks = seq(2005, 2020, by = 3))


ggsave("output_plots/emissions_by_fuel_and_enduse.png",
  device = "png", dpi = "print",
  width = 8, height = 6
)  
  
library(patchwork)
d+f+plot_layout(guides = 'collect',)+plot_annotation(tag_levels = 'a')&theme(legend.position = "top",plot.title = element_blank())&guides(fill = guide_legend(nrow = 1))

ggsave("output_plots/emissions_by_fuel_patchwork.png",
  device = "png", dpi = "print",
  width = 9, height = 5
)

#Aggregate plot written by Paras
# Data Wrangling
data2 <- fuel_wise %>% 
  filter(`Level 3` %in% c("Public Electricity Generation", "Residential", "Transport", "Captive Power Plants", "Industries")) %>% 
  select(`Level 3`, Year, value, fuels, `Level 6`) %>% 
  group_by(fuels, `Level 3`, Year) %>% 
  summarise(value = sum(value), .groups = 'drop') %>% 
  pivot_wider(names_from = `Level 3`, values_from = value) %>% 
  mutate(`Electricity Generation` = `Captive Power Plants` + `Public Electricity Generation`) %>% 
  select(-`Public Electricity Generation`, -`Captive Power Plants`) %>% 
  pivot_longer(cols = -c(fuels, Year), names_to = "sector", values_to = "value") %>% 
  filter(!is.na(value))

# Plotting
f <- ggplot(data2, aes(x = Year, y = value / 10^6, fill = fuels)) +
  geom_col() +
  facet_wrap(~sector, scales = "free", ncol = 2) + # Adjust the number of columns in the facets
  labs(
    x = "", 
    y = "Emissions (MtCO2e)", 
    title = "Emissions by Fuel and End-Use Sector"
  ) +
  scale_fill_manual(values = my_custom_palette) +
  theme(
    legend.position = "top", # Place legend on top
    legend.text = element_text(size = 10), # Adjust legend text size
    legend.title = element_text(size = 12), # Adjust legend title size
    legend.key.size = unit(0.5, "cm"), # Resize legend keys
    legend.spacing.y = unit(0.3, "cm"), # Add spacing between legend items
    axis.text.x = element_text(size = 10, angle = 45, vjust = 0.8, hjust = 0.8),
    panel.spacing = unit(1, "lines") # Add space between facets
  ) +
  guides(
    fill = guide_legend(nrow = 2, keywidth = 0.8, keyheight = 0.4, title.hjust = 0.5) # Refine legend layout
  ) +
  scale_x_discrete(breaks = seq(2005, 2020, by = 3))


# Combine with Patchwork
final_plot <- d + f + 
  plot_layout(guides = 'collect') + 
  plot_annotation(tag_levels = 'a') & 
  theme(legend.position = "top", plot.title = element_blank()) & 
  guides(fill = guide_legend(nrow = 2)) # Consolidate legend layout

final_plot
# Save the Plot
ggsave(
  "output_plots/emissions_by_fuel_and_enduse.png",
  device = "png", dpi = "print",
  width = 10, height = 8
)


##################
```


## Energy emissions
```{r}
level3_energy <- data %>%
  filter(`Level 1`=="Energy") %>% filter(`Level 3` != "Agriculture") %>%
  #  filter(!is.na(`Emission / Removal / Bunker`)) %>% 
  mutate(`Level 3` = case_when(
    `Level 3` %in% c("Captive Power Plants", "Public Electricity Generation") ~ "Electricity Generation",
    TRUE ~ `Level 3`
  )) %>%
  group_by(`Level 3`,Year) %>% 
   summarise(value=sum(value)) %>% 
  ungroup() %>% 
  group_by(Year) %>% 
  mutate(percent=round(value/sum(value)*100,0)) %>% 
  ungroup() %>% 
  mutate(sector=if_else(percent<7,"Other",`Level 3`,)) %>% 
  group_by(Year,sector) %>% 
  summarise(value=sum(value)) %>% 
  mutate(percent=round(value/sum(value)*100,0))

level3_energy_tot <- level3_energy %>% 
  group_by(Year) %>% 
  summarise(total=sum(value))




####Type 1  
ggplot() +
  geom_col(level3_energy, mapping = aes(x = Year, y = value / 10^6, fill = sector)) +
  geom_text(data = level3_energy_tot, 
            aes(x = Year, y = total / 10^6, label = paste0(format(round(total / 10^6, 2), nsmall = 2))), 
            vjust = -0.5, color = "black", size = 3) +
  geom_text(level3_energy,
            mapping = aes(x = Year, y = value / 10^6, fill = sector, 
                          label = ifelse(percent > 2, paste0(percent, "%"), "")), 
            position = position_stack(vjust = 0.5), size = 3, color = "black") +
  ggthemes::theme_pander() +
  labs(x = "", y = "Emissions (MtCO2e)", title = "Energy sector emissions") +
  scale_fill_manual(values = my_custom_palette) +
  theme(legend.position = "top",
        axis.text.x = element_text(size = 9, angle = 45, vjust = 0.8, hjust = 0.8)) +
  guides(fill = guide_legend(nrow = 2))
  # Set the number of rows in the legend

ggsave("output_plots/energy_emissions.png",
  device = "png", dpi = "print",
  width = 9, height = 6
)

#Type 2
a <- ggplot()+
  geom_area(data = level3_energy,mapping = aes(x = Year, y = value/10^6,fill=sector,group=interaction(sector)))+
geom_line(data = level3_energy, mapping = aes(x = Year, y = value/10^6, group = interaction(sector)), show.legend = F,position = position_stack(),color="grey") +
  geom_point(data = level3_energy, mapping = aes(x = Year, y = value/10^6, group = interaction(sector)), show.legend = F,position = position_stack(),color="grey")+ 
   geom_text(data = level3_energy_tot, aes(x = Year, y = total/10^6, label = paste0(round(total/10^6, 0))), vjust = -0.5, color = "black", size = 3)+
  theme_pubclean(base_size = 14)+
    scale_fill_manual(values = my_custom_palette)+
  labs(x = "", y = "Emissions (MtCO2e)",title = "Energy sector emissions")+

  theme(legend.position = "top",
        axis.text.x = element_text(size = 10, angle = 45, vjust = 0.8, hjust = 0.8))+
  guides(fill = guide_legend(nrow = 2))+  # Set the number of rows in the legend 
  scale_y_continuous(expand = expansion(mult = c(0, 0.1)))+
  scale_x_discrete(breaks = c(seq(2006,2020,2),2020))  # Display alternate years

 b <- ggplot(data = level3_energy %>% filter(Year==2020),mapping = aes(x = Year, y = value/10^6))+
  geom_col(aes(fill=sector))+
 geom_text(mapping=aes(fill = sector, label = ifelse(percent > 3, paste0(percent, "%"), "")), position = position_stack(vjust = 0.5), size = 3, color = "white")+
 theme_void(base_size = 14)+
    scale_fill_manual(values = my_custom_palette)+
  guides(colour = "none", fill = "none")

library(patchwork)
(a|b) + 
  plot_layout(widths = c(3, 1))+  theme(legend.position = "top")

 
 ggsave("output_plots/energy_emissions_2.png",
  device = "png", dpi = "print",
  width = 8, height = 6
)



 
```

## Energy emissions: Transport
```{r}
level4_trans <- data %>%
     # mutate(`Emission / Removal / Bunker`=gsub(x = `Emission / Removal / Bunker`,"Removals","Emissions")) %>% 
  filter(`Level 1`=="Energy" & `Level 3`=="Transport") %>% 
  #  filter(!is.na(`Emission / Removal / Bunker`)) %>% 
  group_by(`Level 4`,Year) %>% 
   summarise(value=sum(value)) %>% 
  ungroup() %>% 
  group_by(Year) %>% 
  mutate(percent=round(value/sum(value)*100,0))


#Transport sector emissions  
ggplot(level4_trans) +
  aes(x = Year, y = value/10^6, fill = `Level 4`,label = paste0(percent, "%")) +
  geom_col() +
 geom_text(aes(label = ifelse(percent > 2, paste0(percent, "%"), "")),
            position = position_stack(vjust = 0.5), size = 3, color = "black") +# Adjust the position and size of the text
 ggthemes::theme_pander() +
  labs(x = "", y = "Emissions (MtCO2e)", title = "Transport sector emissions") +
  scale_fill_manual(values = my_custom_palette) + # Use your custom color palette
  theme(legend.position = "top",
        axis.text.x = element_text(size = 9, angle = 45, vjust = 0.8, hjust = 0.8)) +
  guides(fill = guide_legend(nrow = 2))  # Set the number of rows in the legend  # Set the number of rows in the legend

 ggsave("output_plots/Transport Sector Emissions",
  device = "png", dpi = "print",
  width = 8, height = 6
)
```



## Energy emissions: Industry
```{r}
#Industry sector emissions
level4_industry <- data %>%
     # mutate(`Emission / Removal / Bunker`=gsub(x = `Emission / Removal / Bunker`,"Removals","Emissions")) %>% 
  filter(`Level 1`=="Energy" & `Level 3`=="Industries") %>% 
  #  filter(!is.na(`Emission / Removal / Bunker`)) %>% 
  group_by(`Level 4`,Year) %>% 
   summarise(value=sum(value)) %>% 
  ungroup() %>% 
  group_by(Year) %>% 
  mutate(percent=round(value/sum(value)*100,0)) %>% 
  ungroup() %>% 
  mutate(sector=if_else(`Level 4`=="Iron and Steel",`Level 4`,if_else(percent<6,"Other",`Level 4`))) %>% 
  group_by(Year,sector) %>% 
  summarise(value=sum(value)) %>% 
  mutate(percent=round(value/sum(value)*100,0))

level4_indenergy_tot <- level4_industry %>% 
  group_by(Year) %>% 
  summarise(value=sum(value))

#Industry sector emissions  my_custom_palette
ggplot() +
  geom_col(level4_industry, mapping = aes(x = Year, y = value / 10^6, fill = sector)) +
  geom_text(level4_industry, mapping = aes(x = Year, y = value / 10^6, fill = sector, 
                                           label = ifelse(percent > 2, paste0(percent, "%"), "")),
            position = position_stack(vjust = 0.5), size = 3, color = "black") + # Adjust the position and size of the text
  geom_text(data = level4_indenergy_tot, aes(x = Year, y = value / 10^6, label = paste0(round(value / 10^6, 0))), 
            vjust = -0.5, color = "black", size = 3) +
  ggthemes::theme_pander() +
  labs(x = "", y = "Emissions (MtCO2e)", title = "Industry sector emissions") +
  scale_fill_manual(values = my_custom_palette) + # Use custom color palette
  theme(legend.position = "top",
        axis.text.x = element_text(size = 9, angle = 45, vjust = 0.8, hjust = 0.8)) +
  guides(fill = guide_legend(nrow = 3)) # Set the number of rows in the legend

ggsave("output_plots/industry_energy_emissions.png",
  device = "png", dpi = "print",
  width = 8, height = 6
)

ggsave("output_plots/industry_energy_emissions.png",
  device = "png", dpi = "print",
  width = 8, height = 6
)
##############################################33

#code written by paras 
# Group and summarize data for industry emissions
level4_industry <- data %>%
  filter(`Level 1` == "Energy" & `Level 3` == "Industries") %>% 
  group_by(`Level 4`, Year) %>% 
  summarise(value = sum(value, na.rm = TRUE)) %>% 
  ungroup() %>% 
  group_by(Year) %>% 
  mutate(percent = round(value / sum(value) * 100, 0)) %>% 
  ungroup() %>% 
  mutate(sector = if_else(`Level 4` == "Iron and Steel", `Level 4`, 
                          if_else(percent < 6, "Other", `Level 4`))) %>% 
  group_by(Year, sector) %>% 
  summarise(value = sum(value)) %>% 
  mutate(percent = round(value / sum(value) * 100, 0))

# Total emissions for all sectors
level4_indenergy_tot <- level4_industry %>% 
  group_by(Year) %>% 
  summarise(value = sum(value))

# Plot the data
ggplot() +
  geom_col(data = level4_industry, aes(x = Year, y = value / 10^6, fill = sector)) +
  geom_text(data = level4_industry, aes(x = Year, y = value / 10^6, fill = sector, 
                                        label = ifelse(percent > 2, paste0(percent, "%"), "")),
            position = position_stack(vjust = 0.5), size = 3, color = "black") +
  geom_text(data = level4_indenergy_tot, aes(x = Year, y = value / 10^6, 
                                             label = paste0(round(value / 10^6, 2))), 
            vjust = -0.5, color = "black", size = 3) +
  ggthemes::theme_pander() +
  labs(x = "", y = "Emissions (MtCO2e)", title = "Industry Sector Emissions") +
  scale_fill_manual(values = my_custom_palette) +
  theme(legend.position = "top",
        axis.text.x = element_text(size = 9, angle = 45, vjust = 0.8, hjust = 0.8)) +
  guides(fill = guide_legend(nrow = 3))

ggsave("output_plots/industry_energy_emissions.png",
  device = "png", dpi = "print",
  width = 8, height = 6
)

```

## IPPU Emissions
### Level 2
```{r}
level2_ippu <- data %>%
     # mutate(`Emission / Removal / Bunker`=gsub(x = `Emission / Removal / Bunker`,"Removals","Emissions")) %>% 
  filter(`Level 1`=="Industrial Product and Process Use") %>% 
  #  filter(!is.na(`Emission / Removal / Bunker`)) %>% 
  group_by(`Level 2`,Year) %>% 
   summarise(value=sum(value)) %>% 
  ungroup() %>% 
  group_by(Year) %>% 
  mutate(percent=round(value/sum(value)*100,0))

totals <- level2_ippu %>% 
  group_by(Year) %>% 
  summarise(tot=sum(value))

  
ggplot() +
  geom_col(level2_ippu,mapping=aes(x = Year, y = value/10^6, fill = `Level 2`,label = paste0(percent, "%"))) +
  geom_text(data = totals, mapping=aes(x=Year,y=tot/10^6,label = paste0(round(tot/10^6,0))), 
            position = position_stack(vjust = 1.05), size = 3, color = "black")+
 ggthemes::theme_pander() +
  labs(x = "", y = "Emissions (MtCO2e)",title = "IPPU sector emissions")+
  scale_fill_manual(values = my_custom_palette) +
  theme(legend.position = "top",
        axis.text.x = element_text(size = 7, angle = 45, vjust = 0.6, hjust = 0.8))+
  guides(fill = guide_legend(nrow = 2,title = NULL))  # Set the number of rows in the legend

ggsave("output_plots/ippu_energy.png",
  device = "png", dpi = "print",
  width = 8, height = 6
)

```

### Level 3
```{r}
level3_ippu <- data %>%
     # mutate(`Emission / Removal / Bunker`=gsub(x = `Emission / Removal / Bunker`,"Removals","Emissions")) %>% 
  filter(`Level 1`=="Industrial Product and Process Use") %>% 
  #  filter(!is.na(`Emission / Removal / Bunker`)) %>% 
  group_by(`Level 3`,Year) %>% 
   summarise(value=sum(value)) %>% 
  ungroup() %>% 
  group_by(Year) %>% 
  mutate(percent=round(value/sum(value)*100,0))



ggplot(level3_ippu %>% filter (Year>2007)) +
  aes(x = Year, y = value/10^6, fill = `Level 3`,label = paste0(percent, "%")) +
  geom_col() +
geom_text(aes(label = ifelse(percent > 4, paste0(percent, "%"), "")),
            position = position_stack(vjust = 0.5), size = 3, color = "black") +# Adjust the position and size of the text
   ggthemes::theme_pander() +
  labs(x = "", y = "Emissions (MtCO2e)",title = "IPPU sector emissions")+
  scale_fill_manual(values = my_custom_palette) +
  theme(legend.position = "top",
        axis.text.x = element_text(size = 9, angle = 45, vjust = 0.8, hjust = 0.8))+
  guides(fill = guide_legend(nrow = 4))  # Set the number of rows in the legend


ggsave("output_plots/ippu_level3.png",
  device = "png", dpi = "print",
  width = 8, height = 6
)
```

## Waste emissions
### Level 2
```{r}
level2_waste <- data %>%
     # mutate(`Emission / Removal / Bunker`=gsub(x = `Emission / Removal / Bunker`,"Removals","Emissions")) %>% 
  filter(`Level 1`=="Waste") %>% 
  #  filter(!is.na(`Emission / Removal / Bunker`)) %>% 
  group_by(`Level 2`,Year) %>% 
   summarise(value=sum(value)) %>% 
  ungroup() %>% 
  group_by(Year) %>% 
  mutate(percent=round(value/sum(value)*100,0))

ggplot(level2_waste) +
  aes(x = Year, y = value/10^6, fill = `Level 2`,label = paste0(percent, "%")) +
  geom_col() +
geom_text(aes(label = ifelse(percent > 2, paste0(percent, "%"), "")),
            position = position_stack(vjust = 0.5), size = 3, color = "black") +# Adjust the position and size of the text
 ggthemes::theme_pander() +
  labs(x = "", y = "Emissions (MtCO2e)",title = "IPPU sector emissions")+
scale_fill_manual(values = my_custom_palette) +
  theme(legend.position = "top",
        axis.text.x = element_text(size = 9, angle = 45, vjust = 0.8, hjust = 0.8))+
  guides(fill = guide_legend(nrow = 1,title = NULL))  # Set the number of rows in the legend

ggsave("output_plots/ind_wastewater.png",
  device = "png", dpi = "print",
  width = 8, height = 6
)

```


### Level 3
```{r}
level3_waste <- data %>%
     # mutate(`Emission / Removal / Bunker`=gsub(x = `Emission / Removal / Bunker`,"Removals","Emissions")) %>% 
  filter(`Level 1`=="Waste",`Level 2` == "Industrial Wastewater") %>% 
  #  filter(!is.na(`Emission / Removal / Bunker`)) %>% 
  group_by(`Level 3`,Year) %>% 
   summarise(value=sum(value)) %>% 
  ungroup() %>% 
  group_by(Year) %>% 
  mutate(percent=round(value/sum(value)*100,0)) %>% 
  filter(`Level 3` %in% c("Pulp & Paper","Iron & Steel","Petroleum","Sugar") )

ggplot(level3_waste) +
  aes(x = Year, y = value/10^6, fill = `Level 3`,label = paste0(percent, "%")) +
  geom_col()+
geom_text(aes(label = ifelse(percent > 2, paste0(percent, "%"), "")),
            position = position_stack(vjust = 0.5), size = 3, color = "black") +# Adjust the position and size of the text
 ggthemes::theme_pander() +
  labs(x = "", y = "Emissions (MtCO2e)",title = "Industrial waste emissions")+
scale_fill_manual(values = my_custom_palette) +
  theme(legend.position = "top",
        axis.text.x = element_text(size = 9, angle = 45, vjust = 0.8, hjust = 0.8))+
  guides(fill = guide_legend(nrow = 3,title = NULL))  # Set the number of rows in the legend

ggsave("output_plots/ind_level3_wastewater.png",
  device = "png", dpi = "print",
  width = 8, height = 6
)

```


## AFOLU Emissions/Sequestration

### Level 2
```{r}
level2_afolu <- data %>%
     # mutate(`Emission / Removal / Bunker`=gsub(x = `Emission / Removal / Bunker`,"Removals","Emissions")) %>% 
  filter(`Level 1`=="Agriculture, Forestry and Other Land Use",Emissions_Removal_Bunker=="Emissions") %>% 
  #  filter(!is.na(`Emission / Removal / Bunker`)) %>% 
  group_by(`Level 2`,Year) %>% 
   summarise(value=sum(value)) %>% 
  ungroup() %>% 
  group_by(Year) %>% 
  mutate(percent=round(value/sum(value)*100,0))

ggplot(level2_afolu) +
  aes(x = Year, y = value/10^6, fill = `Level 2`,label = paste0(percent, "%")) +
  geom_col() +
#geom_text(aes(label = ifelse(percent > 2, paste0(percent, "%"), "")),
#            position = position_stack(vjust = 0.5), size = 3, color = "black") +# Adjust the position and size of the text
 scale_fill_manual(values = my_custom_palette) +
  labs(x = "", y = "Emissions (MtCO2e)",title = "AFOLU sector emissions")+
  scale_fill_brewer(type = "qual")+
  theme(legend.position = "top",
        axis.text.x = element_text(size = 9, angle = 45, vjust = 0.8, hjust = 0.8))+
  guides(fill = guide_legend(nrow = 1))  # Set the number of rows in the legend
```

### Level 3
```{r}
level3_afolu <- data %>%
     filter(`Level 1`=="Agriculture, Forestry and Other Land Use",Emissions_Removal_Bunker=="Emissions") %>% 
  #  filter(!is.na(`Emission / Removal / Bunker`)) %>% 
  group_by(`Level 3`,Year) %>% 
   summarise(value=sum(value)) %>% 
  ungroup() %>% 
  group_by(Year) %>% 
  mutate(percent=round(value/sum(value)*100,0))

ggplot(level3_afolu) +
  aes(x = Year, y = value/10^6, fill = `Level 3`,label = paste0(percent, "%")) +
  geom_col() +
#geom_text(aes(label = ifelse(percent > 2, paste0(percent, "%"), "")),
#            position = position_stack(vjust = 0.5), size = 3, color = "black") +# Adjust the position and size of the text
 scale_fill_manual(values = my_custom_palette) +
  labs(x = "", y = "Emissions (MtCO2e)",title = "AFOLU sector emissions")+
  scale_fill_ucscgb()+
  theme(legend.position = "top",
        axis.text.x = element_text(size = 9, angle = 45, vjust = 0.8, hjust = 0.8))+
    guides(fill = guide_legend(nrow = 4))  # Set the number of rows in the legend

```



# Energy-use

```{r}
activity <- read_excel("C:/Users/Paras/Desktop/Uttarakhand graphs/GHGPI-Energy-Estimates-by-CSTEP-2005-to-2018.xlsx",sheet = "Activity data") %>% 
  pivot_longer(`2005`:`2020`,names_to = "Year") %>% 
  filter(State == "Uttarakhand")


```

## Energy-level
```{r}
level3_activity <- activity %>% 
    group_by(`Level 3`,Year) %>% 
   summarise(value=sum(value,na.rm = T)) %>% 
  ungroup() %>% 
  group_by(Year) %>% 
  mutate(percent=round(value/sum(value)*100,0))

ggplot(level3_activity) +
  aes(x = Year, y = value/10^3, fill = `Level 3`,label = paste0(percent, "%")) +
  geom_col() +
#geom_text(aes(label = ifelse(percent > 2, paste0(percent, "%"), "")),
#            position = position_stack(vjust = 0.5), size = 3, color = "black") +# Adjust the position and size of the text
 ggthemes::theme_pander() +
  labs(x = "", y = "Total fuel consumed (kt)",title = "Fuel consumed")+
scale_fill_manual(values = my_custom_palette) +
  theme(legend.position = "top",
        axis.text.x = element_text(size = 9, angle = 45, vjust = 0.8, hjust = 0.8))+
  guides(fill = guide_legend(nrow = 3))  # Set the number of rows in the legend
```

## Transport sector
```{r}
level5_activity_trans <- activity %>% 
    filter(`Level 3`=="Transport") %>% 
    group_by(`Level 5`,Year) %>% 
   summarise(value=sum(value,na.rm = T)) %>% 
  ungroup() %>% 
  group_by(Year) %>% 
  mutate(percent=round(value/sum(value)*100,0))

ggplot(level5_activity_trans) +
  aes(x = Year, y = value/10^3, fill = `Level 5`,label = paste0(percent, "%")) +
  geom_col() +
geom_text(aes(label = ifelse(percent > 2, paste0(percent, "%"), "")),
            position = position_stack(vjust = 0.5), size = 3, color = "black") +# Adjust the position and size of the text
scale_fill_manual(values = my_custom_palette) +
  labs(x = "", y = "Total fuel consumed (kt)",title = "Fuel consumed")+
scale_fill_manual(values = my_custom_palette) +
  theme(legend.position = "top",
        axis.text.x = element_text(size = 9, angle = 45, vjust = 0.8, hjust = 0.8))+
  guides(fill = guide_legend(nrow = 2))  # Set the number of rows in the legend
```

### Transport sector disaggregated   
```{r}
level4_5_activity_trans <- activity %>% 
    filter(`Level 3`=="Transport") %>% 
    group_by(`Level 4`,`Level 5`,Year) %>% 
   summarise(value=sum(value,na.rm = T)) %>% 
  ungroup() %>% 
  group_by(Year,`Level 4`) %>% 
  mutate(percent=round(value/sum(value)*100,0))

ggplot(level4_5_activity_trans %>% filter(`Level 4`!="Navigation")) +
  aes(x = Year, y = value/10^3, fill = `Level 5`,label = paste0(percent, "%")) +
  geom_col() +
geom_text(aes(label = ifelse(percent > 2, paste0(percent, "%"), "")),
            position = position_stack(vjust = 0.5), size = 3, color = "black") +# Adjust the position and size of the text
scale_fill_manual(values = my_custom_palette) +
  facet_wrap(~`Level 4`,scales = "free")+
  labs(x = "", y = "Total fuel consumed (kt)",title = "Transport sector: Fuel consumed")+
  scale_fill_manual(values = my_custom_palette) +
  theme(legend.position = "top",
        axis.text.x = element_text(size = 9, angle = 45, vjust = 0.8, hjust = 0.8))+
  guides(fill = guide_legend(nrow = 2))  # Set the number of rows in the legend

```

## Residential sector
```{r}
level5_activity_res <- activity %>% 
    filter(`Level 3`=="Residential") %>% 
    group_by(`Level 5`,Year) %>% 
   summarise(value=sum(value,na.rm = T)) %>% 
  ungroup() %>% 
  group_by(Year) %>% 
  mutate(percent=round(value/sum(value)*100,0))

ggplot(level5_activity_res) +
  aes(x = Year, y = value/10^3, fill = `Level 5`,label = paste0(percent, "%")) +
  geom_col() +
geom_text(aes(label = ifelse(percent > 2, paste0(percent, "%"), "")),
            position = position_stack(vjust = 0.5), size = 3, color = "black") +# Adjust the position and size of the text
 ggthemes::theme_pander() +
  labs(x = "", y = "Total fuel consumed (kt)",title = "Fuel consumed: Residential")+
 scale_fill_manual(values = my_custom_palette) +
  theme(legend.position = "top",
        axis.text.x = element_text(size = 9, angle = 45, vjust = 0.8, hjust = 0.8))+
  guides(fill = guide_legend(nrow = 2))  # Set the number of rows in the legend
```

## Commercial sector
```{r}
level5_activity_comm <- activity %>% 
    filter(`Level 3`=="Commercial") %>% 
    group_by(`Level 5`,Year) %>% 
   summarise(value=sum(value,na.rm = T)) %>% 
  ungroup() %>% 
  group_by(Year) %>% 
  mutate(percent=round(value/sum(value)*100,0))

ggplot(level5_activity_comm) +
  aes(x = Year, y = value/10^3, fill = `Level 5`,label = paste0(percent, "%")) +
  geom_col() +
geom_text(aes(label = ifelse(percent > 2, paste0(percent, "%"), "")),
            position = position_stack(vjust = 0.5), size = 3, color = "black") +# Adjust the position and size of the text
 ggthemes::theme_pander() +
  labs(x = "", y = "Total fuel consumed (kt)",title = "Fuel consumed: Commercial")+
  scale_fill_ucscgb()+
  theme(legend.position = "top",
        axis.text.x = element_text(size = 9, angle = 45, vjust = 0.8, hjust = 0.8))+
  guides(fill = guide_legend(nrow = 2,title = NULL))  # Set the number of rows in the legend
```

## Agricultural sector
```{r}
level5_activity_agri <- activity %>% 
    filter(`Level 3`=="Agriculture") %>% 
    group_by(`Level 5`,Year) %>% 
   summarise(value=sum(value,na.rm = T)) %>% 
  ungroup() %>% 
  group_by(Year) %>% 
  mutate(percent=round(value/sum(value)*100,0))

ggplot(level5_activity_agri) +
  aes(x = Year, y = value/10^3, fill = `Level 5`,label = paste0(percent, "%")) +
  geom_col() +
geom_text(aes(label = ifelse(percent > 2, paste0(percent, "%"), "")),
            position = position_stack(vjust = 0.5), size = 3, color = "black") +# Adjust the position and size of the text
 ggthemes::theme_pander() +
  labs(x = "", y = "Total fuel consumed (kt)",title = "Fuel consumed: Agriculture")+
  scale_fill_ucscgb()+
  theme(legend.position = "top",
        axis.text.x = element_text(size = 9, angle = 45, vjust = 0.8, hjust = 0.8))+
  guides(fill = guide_legend(nrow = 2,title = NULL))  # Set the number of rows in the legend
```

## Industries sector
```{r}

industries <- read.csv("~/CEEW/GHG Platform/INdustry/EM Public state yearly industry energy use emissions.csv") %>% 
  mutate(financial_year_start_date=substr(financial_year_start_date,1,4)) %>% 
  rename(year=financial_year_start_date)


level1_indus <- industries %>% 
 group_by(industry_sector,year) %>% 
   summarise(value=sum(energy_consumed,na.rm = T)) %>% 
  ungroup() %>% 
  group_by(year) %>% 
  mutate(percent=round(value/sum(value)*100,0))


ggplot(level1_indus) +
  aes(x = year, y = value, fill = industry_sector) +
  geom_col() +
geom_text(aes(label = ifelse(percent > 2, paste0(percent, "%"), "")),
            position = position_stack(vjust = 0.5), size = 3, color = "black") +# Adjust the position and size of the text
 ggthemes::theme_pander() +
  labs(x = "", y = "Energy consumed (EJ)",caption = "EM: Public state yearly industry energy use emissions")+
  scale_fill_ucscgb()+
  theme(legend.position = "top",
        axis.text.x = element_text(size = 9, angle = 45, vjust = 0.8, hjust = 0.8))+
  guides(fill = guide_legend(nrow = 5))  # Set the number of rows in the legend
```


# Power
```{r}
power <- read_excel("data/Niti_power_GJ.xlsx") %>% 
  pivot_longer(2:13,names_to = "Year") %>% 
  mutate(Parameter=gsub("- Generation \\(in MU\\)","",Parameter)) %>% 
  filter(!is.na(value)) %>% 
  group_by(Year) %>% 
  mutate(percent=(value/sum(value,na.rm = T))*100) %>% 
  ungroup()


power_total <- power %>%
  group_by(Year) %>%
  summarize(total_value = sum(value,na.rm = T)) %>% 
  ungroup()

ggplot() +
  geom_col(power,mapping = aes(x = Year, y = value/1000, fill = Parameter))+
geom_text(power,mapping=aes(x = Year, y = value/1000, fill=Parameter, label = ifelse(percent > 2, paste0(round(percent,0), "%"), "")),
            position = position_stack(vjust = 0.5), size = 3, color = "white")+ # Adjust the position and size of the text
  geom_text(data = power_total, aes(x = Year, y = total_value/1000, label = round(total_value/1000,0)),
            vjust = -0.5, size =3, color = "black")+  # Add total values on top of bars

  labs(x = "", y = "Electricity Generation (BU)",caption = "Source: Niti Aayog Climate and Energy Dashboard")+
#theme_pubclean(base_size = 12)+
    scale_fill_manual(values = my_custom_palette)+
  theme(legend.title = element_blank(),legend.position = "top",
        axis.text.x = element_text(size = 9, angle = 45, vjust = 0.8, hjust = 0.8))+
guides(fill = guide_legend(nrow = 2))  # Set the number of rows in the legend

ggsave("output_plots/power_generation.png",
  device = "png", dpi = "print",
  width = 8, height = 6
)



```

# Macroeconomy

```{r eval=FALSE, include=FALSE}
agri1 <- read_excel("C:\Users\Paras/Desktop/Uttarakhand graphs/GROSS STATE VALUE ADDED BY ECONOMIC ACTIVITY - AGRICULTURE (2).XLSX",   sheet = "T_32(iii)", skip = 5,na = c("-","-*"))%>% mutate(`...1`=gsub("\\*","",`...1`))

agri2 <- read_excel("Uttarakhand graphs/GROSS STATE VALUE ADDED BY ECONOMIC ACTIVITY - AGRICULTURE.XLSX",     sheet = "T_32(iv)", skip = 5,na = c("-","-*")) %>% slice(1:33) %>% mutate(`...1`=gsub("\\*","",`...1`))

agri <- left_join(agri1,agri2,by="...1") %>% rename("State"="...1") %>% pivot_longer(cols = 2:13,names_to = "Year") %>% 
  mutate(sector="Agriculture")
###########################
bank1 <- read_excel("data/GROSS STATE VALUE ADDED BY ECONOMIC ACTIVITY - BANKING AND INSURANCE.XLSX",     sheet = "T_48(iii)", skip = 5,na = c("-","-*"))
bank2 <- read_excel("data/GROSS STATE VALUE ADDED BY ECONOMIC ACTIVITY - BANKING AND INSURANCE.XLSX",     sheet = "T_48(iv)", skip = 5,na = c("-","-*")) %>% slice(1:33) %>% mutate(...1=gsub(x = ...1,"\\*",replacement=""))

bank <- left_join(bank1,bank2,by="...1") %>% rename("State"="...1") %>% pivot_longer(cols = 2:13,names_to = "Year")  %>%  mutate(sector="Banking")
###########################3
cons1 <- read_excel(path = "data/GROSS STATE VALUE ADDED BY ECONOMIC ACTIVITY - CONSTRUCTION.XLSX",     sheet = "T_40(iii)", skip = 5,na = c("-","-*"))
cons2 <- read_excel("data/GROSS STATE VALUE ADDED BY ECONOMIC ACTIVITY - CONSTRUCTION.XLSX",     sheet = "T_40(iv)", skip = 5,na = c("-","-*")) %>% slice(1:33) %>% mutate(...1=gsub(x = ...1,"\\*",replacement=""))

cons <- left_join(cons1,cons2,by="...1") %>% rename("State"="...1") %>% pivot_longer(cols = 2:13,names_to = "Year")  %>% mutate(sector="Construction")
#############################
ind1 <- read_excel(path = "data/GROSS STATE VALUE ADDED BY ECONOMIC ACTIVITY - INDUSTRY.XLSX",     sheet = "T_44(iii)", skip = 5,na = c("-","-*"))
ind2 <- read_excel("data/GROSS STATE VALUE ADDED BY ECONOMIC ACTIVITY - INDUSTRY.XLSX",     sheet = "T_44(iv)", skip = 5,na = c("-","-*")) %>% slice(1:33) %>% mutate(...1=gsub(x = ...1,"\\*",replacement=""))

ind <- left_join(ind1,ind2,by="...1") %>% rename("State"="...1") %>% pivot_longer(cols = 2:13,names_to = "Year")  %>% mutate(sector="Industry")
###################

manf1 <- read_excel(path = "data/GROSS STATE VALUE ADDED BY ECONOMIC ACTIVITY - MANUFACTURING.XLSX",     sheet = "T_36(iii)", skip = 5,na = c("-","-*"))%>% mutate(`...1`=gsub("\\*","",`...1`))

manf2 <- read_excel("data/GROSS STATE VALUE ADDED BY ECONOMIC ACTIVITY - MANUFACTURING.XLSX",     sheet = "T_36(iv)", skip = 5,na = c("-","-*")) %>% slice(1:33) %>% mutate(...1=gsub(x = ...1,"\\*",replacement=""))


manf <- left_join(manf1,manf2,by="...1") %>% rename("State"="...1")  %>% pivot_longer(cols = 2:13,names_to = "Year") %>% mutate(sector="Manufacturing")
####################

serv1 <- read_excel(path = "Uttarakhand graphs/GROSS STATE VALUE ADDED BY ECONOMIC ACTIVITY - SERVICES.XLSX",     sheet = "T_52(iii)", skip = 5,na = c("-","-*"))
serv2 <- read_excel("data/GROSS STATE VALUE ADDED BY ECONOMIC ACTIVITY - SERVICES.XLSX",     sheet = "T_52(iv)", skip = 5,na = c("-","-*")) %>% slice(1:33) %>% mutate(...1=gsub(x = ...1,"\\*",replacement=""))

serv <- left_join(serv1,serv2,by="...1") %>% rename("State"="...1") %>% pivot_longer(cols = 2:13,names_to = "Year")  %>% mutate(sector="Services")
####################

GVA_economy <- bind_rows(agri,bank,cons,ind,manf,serv) %>%
  mutate(State=trimws(State,"right")) %>% 
   group_by(Year,State) %>% 
  mutate(percent=round(value/sum(value)*100,0)) %>% 
  filter(State=="Uttarakhand") %>% 
  ungroup() %>% 
  group_by(sector) %>%
  mutate(Change = (value - lag(value))/lag(value)*100) %>%
  ungroup()
  

tot <- GVA_economy %>% group_by(State,Year) %>% summarise(value=sum(value))

ggplot(GVA_economy %>% filter(!Year %in% '2022-23')) +
  geom_col(aes(x = Year, y = value/100000, fill = sector)) +
geom_text(aes(x = Year, y = value/100000,fill=sector,label = ifelse(percent > 2, paste0(percent, "%"), "")),
            position = position_stack(vjust = 0.5), size = 3, color = "black")+ 
geom_text(data = tot %>% filter(!Year %in% '2022-23'),mapping = aes(x=Year, y=value/100000,label=round(value/100000,0),  vjust=-0.5))+
#ggthemes::theme_pander() +
  labs(x = "", y = "GVA constant prices (000 crore rupees)",caption = "RBI handbook of Indian States")+
  scale_fill_manual(values = my_custom_palette)+
  theme(legend.position = "top",
        axis.text.x = element_text(size = 9, angle = 45, vjust = 0.8, hjust = 0.8))+
guides(fill = guide_legend(nrow = 2))  # Set the number of rows in the legend


ggsave(filename = "output_plots/GVA.png",device = "png",width = 8,height = 6)

# Change in GVA- by sector

ggplot()+
  geom_line(GVA_economy,mapping =aes(x=Year,y=value/100000, color=sector, group=sector))+
  geom_point(GVA_economy,mapping = aes(x=Year, y=value/100000, color=sector, group=sector), size=2)+
  geom_text_repel(GVA_economy%>% filter(Year!="2011-12"),mapping = aes(x=Year,y = value/100000,label=paste0(round(Change,1),"%"),group=sector,color=sector),vjust=-0.5,max.overlaps = Inf,size=3)+
  scale_y_continuous(sec.axis = sec_axis(~ ., name = "GVA by sector (000 crores)")) +
  scale_color_uchicago()+
   ggthemes::theme_pander() +
  labs(x = "", y = "GVA by sector (000 crores)",caption = "RBI: handbook of states in India")+
  theme(legend.position = "top",
        axis.text.x = element_text(size = 9, angle = 45, vjust = 0.8, hjust = 0.8))+
guides(fill = guide_legend(nrow = 2))  # Set the number of rows in the legend

```

```{r}
## From Niti Aayog website
niti <-  read_excel("Data/State_GVA_Trends_UK.xlsx") %>% 
  select(-"Price Type") %>% 
  rename("value"=4) %>% 
  filter(!is.na(value)) %>% 
  group_by(Sector,Year) %>% 
  summarise(value=sum(value)) %>% 
  ungroup() %>% 
  group_by(Year) %>% 
  mutate(percent=value/sum(value)*100)

writexl::write_xlsx(niti,"niti.xlsx")

niti_tot <- niti %>% 
  group_by(Year) %>% 
  summarise(value=sum(value))


ggplot()+
  geom_col(niti,mapping=aes(x=Year,y=value/10000000,fill=Sector))+
geom_text(niti,mapping = aes(x = Year, y = value/10000000,fill=Sector,label = ifelse(percent > 2, paste0(round(percent,0), "%"), "")),
            position = position_stack(vjust = 0.5), size = 3, color = "white")+ 
geom_text(data = niti_tot %>% filter(!Year %in% '2022-23'),mapping = aes(x=Year, y=value/10000000,label=round(value/10000000,0),  vjust=-0.5))+
#theme_pubclean(base_size = 12)+
    scale_fill_manual(values = my_custom_palette)+
  labs(x = "", y = "GVA constant prices ( Lakh crore)",caption = "")+
 
  theme(legend.position = "top",
         legend.text = element_text(size = 7),
        axis.text.x = element_text(size = 9, angle = 45, vjust = 0.8, hjust = 0.8))+
guides(fill = guide_legend(nrow = 4))  # Set the number of rows in the legend

ggsave(filename = "output_plots/GVA_niti.png",device = "png",width = 8,height = 6)
####################################################
# Categorize sectors into the provided categories
###Code modified by paras
niti <- read_excel("Data/State_GVA_Trends_UK.xlsx") %>% 
  select(-"Price Type") %>% 
  rename("value" = 4) %>% 
  filter(!is.na(value)) %>% 
  group_by(Sector, Year) %>% 
  summarise(value = sum(value)) %>% 
  ungroup() %>% 
  group_by(Year) %>% 
  mutate(percent = value / sum(value) * 100)

# Add a new column for sector categories, combining Agriculture and Mining into one category
niti <- niti %>% 
  mutate(Sector_Category = case_when(
    grepl("Manufacturing", Sector, ignore.case = TRUE) ~ "Manufacturing",
    grepl("Construction", Sector, ignore.case = TRUE) ~ "Construction",
    grepl("Agriculture|Mining", Sector, ignore.case = TRUE) ~ "Agriculture & Mining",  # Combine Agriculture and Mining
    TRUE ~ "Other Services"  # All other sectors are categorized as Other Services
  ))

# Aggregate all other service sectors (excluding Agriculture & Mining) into the "Other Services" category
niti_other_services <- niti %>% 
  filter(Sector_Category == "Other Services") %>% 
  group_by(Year) %>% 
  summarise(value = sum(value), 
            percent = sum(percent)) %>% 
  ungroup()

# Replace individual service sectors with the total "Other Services" category
niti <- niti %>% 
  filter(Sector_Category != "Other Services") %>%  # Keep Manufacturing, Construction, Agriculture & Mining
  bind_rows(niti_other_services %>% mutate(Sector_Category = "Other Services"))

# Calculate total value for each year
niti_tot <- niti %>% 
  group_by(Year) %>% 
  summarise(value = sum(value))

# Create the plot
ggplot() +
  geom_col(niti, mapping = aes(x = Year, y = value / 10000000, fill = Sector_Category)) + 
  # Add percentage labels on top of each segment in the stacked bars
  geom_text(niti, mapping = aes(x = Year, y = value / 10000000, fill = Sector_Category, 
                                label = ifelse(percent > 2, paste0(round(percent, 0), "%"), "")),
            position = position_stack(vjust = 0.5), size = 3, color = "white") + 
  # Add absolute total value labels on top of the entire bar for each year
  geom_text(data = niti_tot, mapping = aes(x = Year, y = value / 10000000, 
                                            label = sprintf("%.2f", value / 10000000)), 
            vjust = -0.5, size = 3, color = "black") + 
  scale_fill_manual(values = my_custom_palette) +
  labs(x = "", y = "GVA constant prices (Lakh crore)", caption = "") +
  theme(legend.position = "top",
        legend.text = element_text(size = 7),
        axis.text.x = element_text(size = 9, angle = 45, vjust = 0.8, hjust = 0.8)) +
  guides(fill = guide_legend(nrow = 4))  # Set the number of rows in the legend

# Save the plot
ggsave(filename = "output_plots/GVA_niti.png", device = "png", width = 8, height = 6)

```

# Forests
```{r}
forests1 <- read_excel("data/RBI_state_forest_cover.XLSX", 
    sheet = "T_101(i)", skip = 3,na = c("-","-*"))
forests2 <- read_excel("data/RBI_state_forest_cover.XLSX", 
    sheet = "T_101(ii)", skip = 3,na = c("-","-*")) %>% slice(1:37)

forests <- left_join(forests1,forests2,by="State/Union Territory") %>% 
  rename(State="State/Union Territory") %>% 
  select(1,9:19) %>% 
   pivot_longer(cols = 2:12,names_to = "Year") %>% 
  arrange(State, Year) %>%
  group_by(State) %>%
  mutate(Change = (value - lag(value))/lag(value)*100) %>%
  ungroup() %>% 
  filter(State %in% c("Uttarakhand"))

ggplot()+
  geom_line(forests,mapping =aes(x=Year,y=value/1000,color=State,group=State))+
  geom_point(forests,mapping =aes(x=Year,y=value/1000,color=State,group=State),size=2)+
  geom_text(forests %>% filter(Year!=2001),mapping = aes(x=Year,y = value/1000,label=paste0(round(Change,1),"%"),group=State),vjust=-0.5)+
  scale_color_wsj()+
   ggthemes::theme_pander() +
  labs(x = "", y = "Forest cover (000 sq km)",caption = "Source: India State of Forest Report 2001-2021, Forest Survey of India")+
  theme(legend.position = "top",
        axis.text.x = element_text(size = 9, angle = 45, vjust = 0.8, hjust = 0.8))+
guides(fill = guide_legend(nrow = 2))  # Set the number of rows in the legend

```

### Trees
```{r}
trees <- read_excel("data/RBI_state_tree_cover.XLSX", 
    sheet = "T_102", na = c("-","*"), skip = 3) %>% 
   rename(State="State/Union Territory") %>% 
  slice(1:37) %>% 
   pivot_longer(cols = 2:11,names_to = "Year") %>% 
  arrange(State, Year) %>%
  group_by(State) %>%
  mutate(Change = (value - lag(value))/lag(value)*100) %>%
  ungroup() %>% 
  filter(State %in% c("Uttarakhand"))

ggplot()+
  geom_line(trees,mapping =aes(x=Year,y=value,color=State,group=State))+
  geom_point(trees,mapping =aes(x=Year,y=value,color=State,group=State),size=2)+
  geom_text_repel(trees %>% filter(Year!=2001),mapping = aes(x=Year,y = value,label=paste0(round(Change,1),"%"),group=State,color=State),vjust=-0.5)+
  scale_color_wsj()+
   ggthemes::theme_pander() +
  labs(x = "", y = "Tree cover (sq km)",caption = "Source: India State of Forest Report 2001-2021, Forest Survey of India")+
  theme(legend.position = "top",
        axis.text.x = element_text(size = 9, angle = 45, vjust = 0.8, hjust = 0.8))+
guides(fill = guide_legend(nrow = 2))  # Set the number of rows in the legend
```



